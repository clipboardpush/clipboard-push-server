{% extends "base.html" %}

{% block title %}Dashboard | Clipboard Man{% endblock %}
{% block body_class %}page-dashboard{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <aside class="sidebar" aria-label="Room navigation">
        <header class="sidebar-header">
            <p class="kicker">Clipboard Push Plus</p>
            <h1>Relay Console</h1>
            <p class="text-meta">Realtime dashboard for connected clients.</p>
        </header>

        <section class="room-nav-wrap">
            <h2 class="sidebar-section-title">Active Rooms</h2>
            <ul class="room-list" id="room-list">
                <li>
                    <button type="button" class="room-link active" data-room="all">
                        <span>All Rooms</span>
                        <span class="nav-badge">0</span>
                    </button>
                </li>
            </ul>
        </section>

        <footer class="sidebar-footer">
            <p class="text-meta">Signed in as <strong>{{ current_user.id }}</strong></p>
            <div class="sidebar-footer-actions">
                <button type="button" class="btn btn-outline btn-mini" id="open-change-pw">Change Password</button>
                <a class="btn btn-outline btn-mini" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </footer>
    </aside>

    <main class="main-view">
        <header class="view-header">
            <div>
                <p class="kicker">Room Scope</p>
                <h2 id="current-room-title">All Rooms Overview</h2>
            </div>
            <div class="connection-pill" id="connection-pill">
                <span class="status-indicator" id="connection-status" aria-hidden="true"></span>
                <span id="connection-text">Offline</span>
            </div>
        </header>

        <section class="stats-grid" aria-label="Key metrics">
            <article class="stat-box">
                <p class="stat-label">Total Connections</p>
                <p class="stat-number" id="total-connections">0</p>
            </article>
            <article class="stat-box">
                <p class="stat-label">Active Sessions</p>
                <p class="stat-number" id="total-sessions">0</p>
            </article>
            <article class="stat-box">
                <p class="stat-label">System Uptime</p>
                <p class="stat-number stat-uptime" id="uptime">00:00:00</p>
            </article>
        </section>

        <section class="r2-panel" aria-label="R2 bucket usage">
            <div class="section-head">
                <h3>R2 Bucket Usage</h3>
                <div class="r2-tools">
                    <button type="button" class="btn btn-outline btn-mini" id="r2-refresh-btn">Refresh</button>
                    <button type="button" class="btn btn-danger btn-mini" id="r2-empty-btn">Empty</button>
                </div>
            </div>
            <div class="r2-grid">
                <article class="r2-item">
                    <p class="stat-label">Bucket</p>
                    <p class="r2-value" id="r2-bucket-name">clipboard-push-relay</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Objects</p>
                    <p class="r2-value" id="r2-objects-count">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Total Size</p>
                    <p class="r2-value" id="r2-total-size">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Total Bytes</p>
                    <p class="r2-value" id="r2-total-bytes">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Scanned Objects</p>
                    <p class="r2-value" id="r2-scanned-objects">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Updated At</p>
                    <p class="r2-value" id="r2-updated-at">-</p>
                </article>
            </div>
            <p class="text-meta" id="r2-status-text">Waiting for update...</p>
        </section>

        <section class="table-wrap" aria-label="Connected clients">
            <div class="section-head">
                <h3>Connected Clients</h3>
            </div>
            <div class="table-scroll">
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th scope="col">Client ID</th>
                            <th scope="col">Type</th>
                            <th scope="col">Room</th>
                            <th scope="col">LAN State</th>
                            <th scope="col">Network</th>
                            <th scope="col">Sessions</th>
                        </tr>
                    </thead>
                    <tbody id="client-list">
                        <tr>
                            <td colspan="6" class="empty-cell">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="activity-stream" aria-label="System activity">
            <div class="section-head">
                <h3>System Activity</h3>
                <div class="activity-tools">
                    <span class="activity-count">Entries: <strong id="activity-count">0</strong></span>
                    <button type="button" class="btn btn-outline btn-mini" id="activity-filter-all">All</button>
                    <button type="button" class="btn btn-outline btn-mini" id="activity-filter-none">None</button>
                    <button type="button" class="btn btn-outline btn-mini" id="clear-activity">Clear</button>
                </div>
            </div>
            <div class="activity-filter" id="activity-filter" aria-label="Activity type filters"></div>
            <div id="activity-log" class="activity-log" role="log" aria-live="polite" aria-relevant="additions"></div>
        </section>
    </main>
</div>

{% endblock %}

{% block modals %}
<!-- Change Password Modal -->
<div class="modal-backdrop" id="pw-modal" role="dialog" aria-modal="true" aria-labelledby="pw-modal-title" hidden>
    <div class="modal-box">
        <header class="modal-header">
            <h3 id="pw-modal-title">Change Password</h3>
            <button type="button" class="modal-close" id="close-pw-modal" aria-label="Close">&times;</button>
        </header>
        <form method="POST" action="{{ url_for('change_password') }}" class="modal-form">
            <div class="form-group">
                <label for="current_password">Current Password</label>
                <input type="password" id="current_password" name="current_password" required autocomplete="current-password">
            </div>
            <div class="form-group">
                <label for="new_password">New Password <span class="text-meta">(min. 8 chars)</span></label>
                <input type="password" id="new_password" name="new_password" required minlength="8" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required minlength="8" autocomplete="new-password">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline btn-mini" id="cancel-pw-modal">Cancel</button>
                <button type="submit" class="btn btn-warning btn-mini">Update Password</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('pw-modal');
    const openBtn = document.getElementById('open-change-pw');
    const closeBtn = document.getElementById('close-pw-modal');
    const cancelBtn = document.getElementById('cancel-pw-modal');

    function openModal() {
        modal.hidden = false;
        document.getElementById('current_password').focus();
    }
    function closeModal() {
        modal.hidden = true;
        modal.querySelector('form').reset();
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.hidden) closeModal();
    });
</script>
{% endblock %}
