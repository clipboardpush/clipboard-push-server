{% extends "base.html" %}

{% block title %}Dashboard | Clipboard Man{% endblock %}
{% block body_class %}page-dashboard{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <aside class="sidebar" aria-label="Room navigation">
        <header class="sidebar-header">
            <p class="kicker">Clipboard Push Plus</p>
            <h1>Relay Console</h1>
            <p class="text-meta">Realtime dashboard for connected clients.</p>
        </header>

        <section class="room-nav-wrap">
            <h2 class="sidebar-section-title">Active Rooms</h2>
            <ul class="room-list" id="room-list">
                <li>
                    <button type="button" class="room-link active" data-room="all">
                        <span>All Rooms</span>
                        <span class="nav-badge">0</span>
                    </button>
                </li>
            </ul>
        </section>

        <footer class="sidebar-footer">
            <p class="text-meta">Signed in as <strong>{{ current_user.id }}</strong></p>
        </footer>
    </aside>

    <main class="main-view">
        <header class="view-header">
            <div>
                <p class="kicker">Room Scope</p>
                <h2 id="current-room-title">All Rooms Overview</h2>
            </div>
            <div class="header-right">
                <button type="button" class="btn btn-outline btn-mini" id="open-settings">Settings</button>
                <button type="button" class="btn btn-outline btn-mini" id="open-change-pw">Change Password</button>
                <a class="btn btn-outline btn-mini" href="{{ url_for('logout') }}">Logout</a>
                <div class="connection-pill" id="connection-pill">
                    <span class="status-indicator" id="connection-status" aria-hidden="true"></span>
                    <span id="connection-text">Offline</span>
                </div>
            </div>
        </header>

        <section class="stats-grid" aria-label="Key metrics">
            <article class="stat-box">
                <p class="stat-label">Total Connections</p>
                <p class="stat-number" id="total-connections">0</p>
            </article>
            <article class="stat-box">
                <p class="stat-label">Active Sessions</p>
                <p class="stat-number" id="total-sessions">0</p>
            </article>
            <article class="stat-box">
                <p class="stat-label">System Uptime</p>
                <p class="stat-number stat-uptime" id="uptime">00:00:00</p>
            </article>
        </section>

        <section class="r2-panel" aria-label="R2 bucket usage">
            <div class="section-head">
                <h3>R2 Bucket Usage</h3>
                <div class="r2-tools">
                    <button type="button" class="btn btn-outline btn-mini" id="r2-refresh-btn">Refresh</button>
                    <button type="button" class="btn btn-danger btn-mini" id="r2-empty-btn">Empty</button>
                </div>
            </div>
            <div class="r2-grid">
                <article class="r2-item">
                    <p class="stat-label">Bucket</p>
                    <p class="r2-value" id="r2-bucket-name">clipboard-push-relay</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Objects</p>
                    <p class="r2-value" id="r2-objects-count">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Total Size</p>
                    <p class="r2-value" id="r2-total-size">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Total Bytes</p>
                    <p class="r2-value" id="r2-total-bytes">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Scanned Objects</p>
                    <p class="r2-value" id="r2-scanned-objects">-</p>
                </article>
                <article class="r2-item">
                    <p class="stat-label">Updated At</p>
                    <p class="r2-value" id="r2-updated-at">-</p>
                </article>
            </div>
            <p class="text-meta" id="r2-status-text">Waiting for update...</p>
        </section>

        <section class="table-wrap" aria-label="Connected clients">
            <div class="section-head">
                <h3>Connected Clients</h3>
            </div>
            <div class="table-scroll">
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th scope="col">Client ID</th>
                            <th scope="col">Type</th>
                            <th scope="col">Room</th>
                            <th scope="col">LAN State</th>
                            <th scope="col">Network</th>
                            <th scope="col">Sessions</th>
                        </tr>
                    </thead>
                    <tbody id="client-list">
                        <tr>
                            <td colspan="6" class="empty-cell">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="activity-stream" aria-label="System activity">
            <div class="section-head">
                <h3>System Activity</h3>
                <div class="activity-tools">
                    <span class="activity-count">Entries: <strong id="activity-count">0</strong></span>
                    <button type="button" class="btn btn-outline btn-mini" id="activity-filter-all">All</button>
                    <button type="button" class="btn btn-outline btn-mini" id="activity-filter-none">None</button>
                    <button type="button" class="btn btn-outline btn-mini" id="clear-activity">Clear</button>
                </div>
            </div>
            <div class="activity-filter" id="activity-filter" aria-label="Activity type filters"></div>
            <div id="activity-log" class="activity-log" role="log" aria-live="polite" aria-relevant="additions"></div>
        </section>
    </main>
</div>

{% endblock %}

{% block modals %}
<!-- Settings Modal -->
<div class="modal-backdrop" id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title" hidden>
    <div class="modal-box modal-box-wide">
        <header class="modal-header">
            <h3 id="settings-modal-title">Server Settings</h3>
            <button type="button" class="modal-close" id="close-settings-modal" aria-label="Close">&times;</button>
        </header>
        <div class="modal-body">
            <p class="text-meta settings-restart-note">Changes are saved to <code>.env</code>. Restart the server for them to take effect.</p>

            <div class="settings-section">
                <h4 class="settings-section-title">File Storage</h4>
                <div class="form-group">
                    <label for="s-STORAGE_BACKEND">Backend</label>
                    <select id="s-STORAGE_BACKEND" name="STORAGE_BACKEND" class="settings-input">
                        <option value="r2">Cloudflare R2</option>
                        <option value="local">Local (server disk)</option>
                    </select>
                </div>
                <div id="local-storage-fields">
                    <div class="form-group">
                        <label for="s-LOCAL_STORAGE_BASE_URL">Server Public URL <span class="text-meta">(used in download links)</span></label>
                        <input type="text" id="s-LOCAL_STORAGE_BASE_URL" name="LOCAL_STORAGE_BASE_URL" class="settings-input" placeholder="https://your.domain.com">
                    </div>
                    <div class="form-group">
                        <label for="s-LOCAL_STORAGE_PATH">Storage Path <span class="text-meta">(absolute or relative to project root)</span></label>
                        <input type="text" id="s-LOCAL_STORAGE_PATH" name="LOCAL_STORAGE_PATH" class="settings-input" placeholder="./data/uploads">
                    </div>
                </div>
            </div>

            <div class="settings-section" id="r2-fields">
                <h4 class="settings-section-title">Cloudflare R2</h4>
                <div class="form-group">
                    <label for="s-R2_ACCOUNT_ID">Account ID</label>
                    <input type="text" id="s-R2_ACCOUNT_ID" name="R2_ACCOUNT_ID" class="settings-input" placeholder="your_account_id">
                </div>
                <div class="form-group">
                    <label for="s-R2_ACCESS_KEY_ID">Access Key ID</label>
                    <input type="text" id="s-R2_ACCESS_KEY_ID" name="R2_ACCESS_KEY_ID" class="settings-input" placeholder="your_access_key_id">
                </div>
                <div class="form-group">
                    <label for="s-R2_SECRET_ACCESS_KEY">Secret Access Key</label>
                    <input type="password" id="s-R2_SECRET_ACCESS_KEY" name="R2_SECRET_ACCESS_KEY" class="settings-input" placeholder="unchanged">
                </div>
                <div class="form-group">
                    <label for="s-R2_BUCKET_NAME">Bucket Name <span class="text-meta">(for file transfers)</span></label>
                    <input type="text" id="s-R2_BUCKET_NAME" name="R2_BUCKET_NAME" class="settings-input" placeholder="clipboard-push-relay">
                </div>
                <div class="form-group">
                    <label for="s-DASHBOARD_R2_BUCKET">Dashboard Bucket <span class="text-meta">(shown in R2 stats panel)</span></label>
                    <input type="text" id="s-DASHBOARD_R2_BUCKET" name="DASHBOARD_R2_BUCKET" class="settings-input" placeholder="clipboard-push-relay">
                </div>
            </div>

            <div class="settings-section">
                <h4 class="settings-section-title">Server</h4>
                <div class="form-group form-group-inline">
                    <input type="checkbox" id="s-FLASK_DEBUG" name="FLASK_DEBUG">
                    <label for="s-FLASK_DEBUG">Enable debug mode <span class="text-meta">(never use in production)</span></label>
                </div>
                <div class="form-group">
                    <label for="s-FIREBASE_CREDENTIALS_PATH">Firebase Credentials Path <span class="text-meta">(optional, leave blank to disable FCM)</span></label>
                    <input type="text" id="s-FIREBASE_CREDENTIALS_PATH" name="FIREBASE_CREDENTIALS_PATH" class="settings-input" placeholder="/path/to/firebase-service-account.json">
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <span class="settings-save-msg text-meta" id="settings-save-msg" hidden></span>
            <button type="button" class="btn btn-outline btn-mini" id="cancel-settings-modal">Cancel</button>
            <button type="button" class="btn btn-outline btn-mini" id="restart-server-btn">Restart Server</button>
            <button type="button" class="btn btn-warning btn-mini" id="save-settings-btn">Save</button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal-backdrop" id="pw-modal" role="dialog" aria-modal="true" aria-labelledby="pw-modal-title" hidden>
    <div class="modal-box">
        <header class="modal-header">
            <h3 id="pw-modal-title">Change Password</h3>
            <button type="button" class="modal-close" id="close-pw-modal" aria-label="Close">&times;</button>
        </header>
        <form method="POST" action="{{ url_for('change_password') }}" class="modal-form">
            <div class="form-group">
                <label for="current_password">Current Password</label>
                <input type="password" id="current_password" name="current_password" required autocomplete="current-password">
            </div>
            <div class="form-group">
                <label for="new_password">New Password <span class="text-meta">(min. 8 chars)</span></label>
                <input type="password" id="new_password" name="new_password" required minlength="8" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required minlength="8" autocomplete="new-password">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline btn-mini" id="cancel-pw-modal">Cancel</button>
                <button type="submit" class="btn btn-warning btn-mini">Update Password</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('pw-modal');
    const openBtn = document.getElementById('open-change-pw');
    const closeBtn = document.getElementById('close-pw-modal');
    const cancelBtn = document.getElementById('cancel-pw-modal');

    function openModal() {
        modal.hidden = false;
        document.getElementById('current_password').focus();
    }
    function closeModal() {
        modal.hidden = true;
        modal.querySelector('form').reset();
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.hidden) closeModal();
    });

    // Settings modal
    const settingsModal = document.getElementById('settings-modal');
    const openSettingsBtn = document.getElementById('open-settings');
    const closeSettingsBtn = document.getElementById('close-settings-modal');
    const cancelSettingsBtn = document.getElementById('cancel-settings-modal');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const saveMsg = document.getElementById('settings-save-msg');
    const backendSelect = document.getElementById('s-STORAGE_BACKEND');
    const localFields = document.getElementById('local-storage-fields');
    const r2Fields = document.getElementById('r2-fields');

    function updateStorageVisibility() {
        const isLocal = backendSelect.value === 'local';
        localFields.style.display = isLocal ? '' : 'none';
        r2Fields.style.display = isLocal ? 'none' : '';
    }
    backendSelect.addEventListener('change', updateStorageVisibility);

    function openSettingsModal() {
        saveMsg.hidden = true;
        fetch('/api/settings').then(r => r.json()).then(data => {
            ['STORAGE_BACKEND','LOCAL_STORAGE_BASE_URL','LOCAL_STORAGE_PATH',
             'R2_ACCOUNT_ID','R2_ACCESS_KEY_ID','R2_SECRET_ACCESS_KEY',
             'R2_BUCKET_NAME','DASHBOARD_R2_BUCKET','FIREBASE_CREDENTIALS_PATH'].forEach(k => {
                const el = document.getElementById('s-' + k);
                if (el) el.value = data[k] || '';
            });
            const debugEl = document.getElementById('s-FLASK_DEBUG');
            debugEl.checked = data['FLASK_DEBUG'] === '1';
            updateStorageVisibility();
            settingsModal.hidden = false;
        });
    }

    function closeSettingsModal() {
        settingsModal.hidden = true;
    }

    saveSettingsBtn.addEventListener('click', function() {
        const payload = {};
        ['STORAGE_BACKEND','LOCAL_STORAGE_BASE_URL','LOCAL_STORAGE_PATH',
         'R2_ACCOUNT_ID','R2_ACCESS_KEY_ID','R2_SECRET_ACCESS_KEY',
         'R2_BUCKET_NAME','DASHBOARD_R2_BUCKET','FIREBASE_CREDENTIALS_PATH'].forEach(k => {
            const el = document.getElementById('s-' + k);
            if (el) payload[k] = el.value;
        });
        payload['FLASK_DEBUG'] = document.getElementById('s-FLASK_DEBUG').checked ? '1' : '0';

        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(r => r.json().then(data => ({ok: r.ok, data}))).then(({ok, data}) => {
            if (ok) {
                saveMsg.textContent = 'Saved. Restart the server for changes to take effect.';
                saveMsg.style.color = '';
            } else {
                saveMsg.textContent = 'Error: ' + (data.error || 'Unknown error');
                saveMsg.style.color = '#fca5a5';
            }
            saveMsg.hidden = false;
        });
    });

    const restartBtn = document.getElementById('restart-server-btn');
    restartBtn.addEventListener('click', function() {
        if (!confirm('Restart the server now?')) return;
        saveMsg.textContent = 'Restarting... page will reload when server is back.';
        saveMsg.style.color = '#fde68a';
        saveMsg.hidden = false;
        restartBtn.disabled = true;
        saveSettingsBtn.disabled = true;
        fetch('/api/restart', {method: 'POST'}).catch(() => {});
        function poll() {
            fetch('/api/settings').then(r => {
                if (r.ok) window.location.reload();
                else setTimeout(poll, 1000);
            }).catch(() => setTimeout(poll, 1000));
        }
        setTimeout(poll, 1500);
    });

    openSettingsBtn.addEventListener('click', openSettingsModal);
    closeSettingsBtn.addEventListener('click', closeSettingsModal);
    cancelSettingsBtn.addEventListener('click', closeSettingsModal);
    settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) closeSettingsModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !settingsModal.hidden) closeSettingsModal();
    });
</script>
{% endblock %}
